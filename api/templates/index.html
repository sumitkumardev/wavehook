<!DOCTYPE html>
<html>
<head>
  <title>WaveHook</title>
  <meta name="theme-color" content="#333333">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      background: black;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
    }

    #viewport {
      height: 100vh;
      width: 100%;
      overflow: hidden;
      position: relative;
    }

    #card {
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: transform 0.35s ease-out;
    }

    img {
      width: 250px;
      border-radius: 10px;
    }

    h2 {
      padding: 10px;
      text-align: center;
    }

    #langPanel {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.95);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .lang-list {
      display: grid;
      grid-template-columns: repeat(2,1fr);
      gap: 10px;
    }

    button {
      margin-top: 12px;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: #1db954;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="viewport">

  <div id="langPanel">
    <h2>What language songs do you want?</h2>
    <div class="lang-list">
      <label><input type="checkbox" value="hindi"> Hindi</label>
      <label><input type="checkbox" value="bhojpuri"> Bhojpuri</label>
      <label><input type="checkbox" value="haryanvi"> Haryanvi</label>
      <label><input type="checkbox" value="telugu"> Telugu</label>
      <label><input type="checkbox" value="english"> English</label>
      <label><input type="checkbox" value="punjabi"> Punjabi</label>
      <label><input type="checkbox" value="tamil"> Tamil</label>
      <label><input type="checkbox" value="all"> All</label>
    </div>
    <button onclick="saveLanguagePreference()">Continue</button>
  </div>

  <div id="card">
    <h2 id="title">Loading...</h2>
    <img id="cover">
    <br><br>
    <audio id="player" controls preload="metadata"></audio>
    <br>
    <button id="nextHookBtn" onclick="playNextHook()">‚è≠ Next Hook</button>
  </div>

</div>

<script>
let startTime = 0;
let scrolling = false;
let offsetY = 0;

const card = document.getElementById("card");
const audio = document.getElementById("player");

const CACHE_KEY = "played_songs_cache";
const LANG_KEY = "language_score";
const LANG_INIT = "language_initialized";

/* ---------- HOOK CONTROL ---------- */
let hooks = [];
let currentHookIndex = 0;

function parseTime(t){
  if(!t) return 0;
  let [m, s] = t.split(":");
  return parseInt(m) * 60 + parseInt(s);
}

function extractHooks(song){
  let list = [];

  if(song.hook?.primehook) list.push(song.hook.primehook);
  if(song.hook?.sechook)   list.push(song.hook.sechook);
  if(song.hook?.subhook)   list.push(song.hook.subhook);

  if(list.length === 0) return ["00:00"];
  return list;
}

function crossfadeTo(seconds){
  const step = 0.05;
  let vol = audio.volume || 1;

  let fadeOut = setInterval(() => {
    vol -= step;
    if(vol <= 0){
      vol = 0;
      clearInterval(fadeOut);

      audio.currentTime = seconds;

      let fadeIn = setInterval(() => {
        vol += step;
        if(vol >= 1){
          vol = 1;
          clearInterval(fadeIn);
        }
        audio.volume = vol;
      }, 30);
    }
    audio.volume = vol;
  }, 30);
}

function playNextHook(){
  if(!hooks.length) return;

  currentHookIndex++;
  if(currentHookIndex >= hooks.length){
    currentHookIndex = 0;
  }

  let sec = parseTime(hooks[currentHookIndex]);
  crossfadeTo(sec);
}

/* ---------- LANGUAGE STORAGE ---------- */

function getLangScore(){
  let d = localStorage.getItem(LANG_KEY);
  return d ? JSON.parse(d) : {};
}

function saveLangScore(obj){
  localStorage.setItem(LANG_KEY, JSON.stringify(obj));
}

function updateLangScore(lang, delta){
  let s = getLangScore();
  if(!s[lang]) s[lang] = 5;
  s[lang] = Math.max(1, Math.min(10, s[lang] + delta));
  saveLangScore(s);
}

function getBestLanguage(){
  let s = getLangScore();
  let best = null, val = -1;
  for(let k in s){
    if(s[k] > val){
      val = s[k];
      best = k;
    }
  }
  return best;
}

function saveLanguagePreference(){
  let checks = document.querySelectorAll("#langPanel input:checked");
  let scores = {};
  let selected = Array.from(checks).map(c => c.value);

  if(selected.includes("all") || selected.length === 0){
    saveLangScore({});
  } else {
    selected.forEach(l => scores[l] = 8);
    saveLangScore(scores);
  }

  localStorage.setItem(LANG_INIT, "true");
  document.getElementById("langPanel").style.display = "none";
  loadSong();
}

function checkFirstTime(){
  if(!localStorage.getItem(LANG_INIT)){
    document.getElementById("langPanel").style.display = "flex";
  }
}

/* ---------- SONG CACHE ---------- */

function getCache(){
  let d = localStorage.getItem(CACHE_KEY);
  return d ? JSON.parse(d) : {};
}

function saveCache(c){
  localStorage.setItem(CACHE_KEY, JSON.stringify(c));
}

function isInCache(id){
  let c = getCache();
  return id in c;
}

function markInCache(id){
  let c = getCache();
  c[id] = Date.now();
  saveCache(c);
}

/* ---------- LOAD SONG ---------- */

async function loadSong(action="skip"){
  let lang = getBestLanguage() || "";
  const res = await fetch(`/next_song?action=${action}&preferred_lang=${lang}`);
  const song = await res.json();

  if(isInCache(song.id)){
    return loadSong("liked");
  }

  document.getElementById("title").innerText = song.name;
  document.getElementById("cover").src = song.image[2].url;

  audio.pause();
  audio.src = song.downloadUrl[4].url;
  audio.preload = "metadata";

  hooks = extractHooks(song);
  currentHookIndex = 0;

  let seconds = parseTime(hooks[0]);

  audio.onloadedmetadata = () => {
    audio.currentTime = seconds;
    audio.volume = 1;
    audio.play();
  };

  if(action === "liked"){
    updateLangScore(song.language || "unknown", +1);
  }
  if(action === "skipped"){
    updateLangScore(song.language || "unknown", -1);
  }

  startTime = Date.now();
  markInCache(song.id);
}

/* ---------- USER ACTION ---------- */

function decideAction(){
  let t = (Date.now() - startTime) / 1000;
  return t > 12 ? "liked" : "skipped";
}

function snapNext(){
  if(scrolling) return;
  scrolling = true;
  let action = decideAction();

  card.style.transform = "translateY(-100%)";

  setTimeout(async () => {
    await loadSong(action);
    card.style.transition = "none";
    card.style.transform = "translateY(100%)";

    requestAnimationFrame(()=>{
      card.style.transition = "transform 0.35s ease-out";
      card.style.transform = "translateY(0)";
      scrolling = false;
    });
  },350);
}

document.addEventListener("wheel", e=>{
  if(scrolling) return;
  offsetY -= e.deltaY * 0.5;
  card.style.transform = `translateY(${offsetY}px)`;
  if(offsetY < -window.innerHeight*0.25){
    offsetY = 0;
    snapNext();
  }
});

let startY = 0;

card.addEventListener("touchstart", e => {
  startY = e.touches[0].clientY;
});

card.addEventListener("touchmove", e => {
  let moveY = e.touches[0].clientY;
  offsetY = moveY - startY;
  card.style.transition = "none";
  card.style.transform = `translateY(${offsetY}px)`;
});

card.addEventListener("touchend", () => {
  if(offsetY < -window.innerHeight * 0.25){
    offsetY = 0;
    snapNext();
  } else {
    card.style.transition = "transform 0.2s ease-out";
    card.style.transform = "translateY(0)";
    offsetY = 0;
  }
});


checkFirstTime();
</script>

</body>
</html>
