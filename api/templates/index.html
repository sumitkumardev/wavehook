<!DOCTYPE html>
<html>
<head>
  <title>WaveHook</title>
  <meta name="theme-color" content="#333333">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      background: black;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
    }

    #viewport {
      height: 100vh;
      width: 100%;
      overflow: hidden;
      position: relative;
    }

    #card {
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transform: translateY(0);
      transition: transform 0.35s ease-out;
      will-change: transform;
    }

    img {
      width: 250px;
      border-radius: 10px;
    }

    h2 {
      padding: 10px;
      text-align: center;
    }
  </style>
</head>
<body>

<div id="viewport">
  <div id="card">
    <h2 id="title">Loading...</h2>
    <img id="cover">
    <br><br>
    <audio id="player" controls preload="metadata"></audio>
  </div>
</div>

<script>
let startTime = 0;
let offsetY = 0;
let scrolling = false;

const card = document.getElementById("card");
const audio = document.getElementById("player");

const CACHE_KEY = "played_songs_cache";
const CACHE_TTL = 24 * 60 * 60 * 1000; // 24 hours

/* ---------------- CACHE FUNCTIONS ---------------- */

function getCache(){
  let data = localStorage.getItem(CACHE_KEY);
  return data ? JSON.parse(data) : {};
}

function saveCache(cache){
  localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
}

function cleanCache(){
  let cache = getCache();
  let now = Date.now();

  for(let id in cache){
    if(now - cache[id] > CACHE_TTL){
      delete cache[id];
    }
  }
  saveCache(cache);
}

function isInCache(songId){
  cleanCache();
  let cache = getCache();
  return songId in cache;
}

function markInCache(songId){
  let cache = getCache();
  cache[songId] = Date.now();
  saveCache(cache);
}

/* ---------------- SONG LOADER ---------------- */

async function loadSong(action="skip") {
  const res = await fetch(`/next_song?action=${action}`);
  const song = await res.json();

  // ðŸ”¥ NEW: if already seen, auto skip
  // if(isInCache(song.id)){
  //   console.log("Already played, skipping:", song.id);
  //   return loadSong("skipped");
  // }
  // new
  if(isInCache(song.id)){
  console.log("Already played, skipping (cache):", song.id);
  return loadSong("liked"); // <-- important change
  }

  document.getElementById("title").innerText = song.name;
  document.getElementById("cover").src = song.image[2].url;

  // audio.src = song.downloadUrl[4].url;

  // let hook = song.hook?.primehook || "00:00";
  // let [m, s] = hook.split(":");
  // let seconds = parseInt(m)*60 + parseInt(s);

  // audio.currentTime = seconds;
  // audio.play().catch(()=>alert("Tap once to allow audio"));

  // new
  audio.pause();
  audio.src = song.downloadUrl[4].url;
  audio.preload = "metadata";

  let hook = song.hook?.primehook || "00:00";
  let [m, s] = hook.split(":");
  let seconds = parseInt(m)*60 + parseInt(s);

  audio.onloadedmetadata = () => {
    audio.currentTime = seconds;   // seek only after metadata
    audio.play().catch(()=>alert("Tap once to allow audio"));
  };



  startTime = Date.now();

  // mark as shown immediately
  markInCache(song.id);
}

/* ---------------- DECISION ---------------- */

function decideAction(){
  let listened = (Date.now() - startTime) / 1000;
  return listened > 12 ? "liked" : "skipped";
}

function snapNext(){
  if(scrolling) return;
  scrolling = true;

  let action = decideAction();

  card.style.transition = "transform 0.35s ease-out";
  card.style.transform = "translateY(-100%)";

  setTimeout(async () => {
    await loadSong(action);

    card.style.transition = "none";
    card.style.transform = "translateY(100%)";

    requestAnimationFrame(() => {
      card.style.transition = "transform 0.35s ease-out";
      card.style.transform = "translateY(0)";
      scrolling = false;
    });

  }, 350);
}

/* ---------------- WHEEL SCROLL ---------------- */

document.addEventListener("wheel", e => {
  if(scrolling) return;

  offsetY -= e.deltaY * 0.5;
  card.style.transition = "none";
  card.style.transform = `translateY(${offsetY}px)`;

  if(offsetY < -window.innerHeight * 0.25){
    offsetY = 0;
    snapNext();
  }
});

/* ---------------- TOUCH SWIPE ---------------- */

let startY = 0;

card.addEventListener("touchstart", e => {
  startY = e.touches[0].clientY;
});

card.addEventListener("touchmove", e => {
  let moveY = e.touches[0].clientY;
  offsetY = moveY - startY;
  card.style.transition = "none";
  card.style.transform = `translateY(${offsetY}px)`;
});

card.addEventListener("touchend", () => {
  if(offsetY < -window.innerHeight * 0.25){
    offsetY = 0;
    snapNext();
  } else {
    card.style.transition = "transform 0.2s ease-out";
    card.style.transform = "translateY(0)";
    offsetY = 0;
  }
});

/* ---------------- FIRST LOAD ---------------- */
cleanCache();
loadSong();
</script>

</body>
</html>
